# Story 2.1.6: Testing, Polish & QA

**Parent Epic:** Story 2.1 Three-Panel Layout Redesign
**Phase:** 7 (Days 18-20)
**Status:** Ready for Development
**Priority:** High
**Estimated Effort:** 3 days

---

## User Story

**As a** quality assurance engineer,
**I want** comprehensive testing, accessibility audit, performance optimization, and cross-browser verification,
**so that** the three-panel layout meets production quality standards and provides an excellent user experience across all devices and browsers.

---

## Acceptance Criteria

### AC1: Accessibility Audit & Fixes
- [ ] Run axe-core accessibility scanner
- [ ] Zero critical violations
- [ ] Zero serious violations
- [ ] Lighthouse accessibility score ≥95
- [ ] All interactive elements keyboard-accessible
- [ ] ARIA labels correct and in Thai
- [ ] Screen reader announces filter changes
- [ ] Color contrast ≥4.5:1 for all text
- [ ] Focus indicators visible (2px purple outline)
- [ ] Touch targets ≥44x44px on mobile

### AC2: Performance Optimization
- [ ] Lighthouse performance score ≥90
- [ ] First Contentful Paint (FCP) <1.5 seconds
- [ ] Largest Contentful Paint (LCP) <2.5 seconds
- [ ] Time to Interactive (TTI) <3 seconds
- [ ] Cumulative Layout Shift (CLS) <0.1
- [ ] Filter response time <100ms
- [ ] Outfit grid render <300ms for 50 outfits
- [ ] Virtual scrolling maintains 60fps
- [ ] No memory leaks (tested over 5 minutes)

### AC3: Cross-Browser Testing
**Desktop Browsers:**
- [ ] Chrome (latest) - Windows & macOS
- [ ] Safari (latest) - macOS
- [ ] Firefox (latest) - Windows & macOS
- [ ] Edge (latest) - Windows

**Mobile Browsers:**
- [ ] Safari - iOS 15+
- [ ] Chrome - Android 10+
- [ ] Samsung Internet - Android

**Verification Points:**
- Layout renders correctly
- Filters work properly
- Thai font displays correctly
- Touch interactions smooth
- No JavaScript errors

### AC4: Responsive Design Testing
**Breakpoints:**
- [ ] Desktop: 1920px, 1440px, 1366px, 1024px
- [ ] Tablet: 1023px, 768px
- [ ] Mobile: 414px, 390px, 375px

**Test Cases:**
- [ ] Three panels visible on desktop
- [ ] Drawer navigation on tablet
- [ ] Bottom tabs on mobile
- [ ] Images scale correctly
- [ ] Text wraps properly
- [ ] Buttons remain accessible
- [ ] No horizontal overflow

### AC5: E2E Test Suite
**Critical User Flows:**
```typescript
// Test 1: Filter and Select Flow
test('User can filter outfits and view details', async ({ page }) => {
  await page.goto('/')

  // Apply filters
  await page.click('text=ผู้หญิง')
  await page.click('text=งานออฟฟิศ')
  await expect(page.locator('[data-testid="outfit-card"]')).toHaveCount(8)

  // Select outfit
  await page.click('[data-testid="outfit-card"] >> nth=0')
  await expect(page.locator('[data-testid="outfit-detail"]')).toBeVisible()

  // Buy product
  const [newPage] = await Promise.all([
    page.waitForEvent('popup'),
    page.click('text=ซื้อเลย >> nth=0')
  ])
  await expect(newPage.url()).toContain('central.co.th')
})

// Test 2: Search and Navigate
test('User can search and navigate', async ({ page }) => {
  await page.goto('/')

  // Search
  await page.fill('[placeholder*="หาชุด"]', 'ทำงาน')
  await page.waitForTimeout(400) // Debounce
  await expect(page.locator('[data-testid="outfit-card"]')).toHaveCount(12)

  // Clear search
  await page.click('[aria-label="Clear search"]')
  await expect(page.locator('[data-testid="outfit-card"]')).toHaveCount(50)
})

// Test 3: URL State Persistence
test('URL state persists across reload', async ({ page }) => {
  await page.goto('/?gender=women&occasion=work&outfit=abc123')

  // Verify filters applied
  await expect(page.locator('input[value="women"]')).toBeChecked()
  await expect(page.locator('input[value="work"]')).toBeChecked()
  await expect(page.locator('[data-testid="outfit-detail"]')).toBeVisible()

  // Reload
  await page.reload()

  // Verify state persisted
  await expect(page.locator('input[value="women"]')).toBeChecked()
  await expect(page.locator('[data-testid="outfit-detail"]')).toBeVisible()
})

// Test 4: Mobile Navigation
test('Mobile bottom tabs work correctly', async ({ page }) => {
  await page.setViewportSize({ width: 375, height: 667 })
  await page.goto('/')

  // Default: Outfits tab
  await expect(page.locator('[data-testid="outfit-grid"]')).toBeVisible()

  // Switch to Filters
  await page.click('text=กรอง')
  await expect(page.locator('[data-testid="filter-panel"]')).toBeVisible()

  // Switch to Chat
  await page.click('text=แชท')
  await expect(page.locator('[data-testid="chat-interface"]')).toBeVisible()
})
```

### AC6: Visual Regression Testing
- [ ] Capture baseline screenshots for all views
- [ ] Compare against baseline on changes
- [ ] No unexpected visual differences
- [ ] Thai text renders consistently
- [ ] Images load correctly
- [ ] Layout matches design specs

### AC7: Error Handling Verification
- [ ] Network error: Shows error message, retry button works
- [ ] Outfit generation failure: Fallback message displays
- [ ] Image load failure: Placeholder shows
- [ ] Invalid URL params: Defaults to valid state
- [ ] Slow outfit generation: Loading state shows
- [ ] Empty filter results: Empty state displays

### AC8: Performance Profiling
- [ ] Profile with React DevTools Profiler
- [ ] Identify unnecessary re-renders
- [ ] Optimize expensive computations
- [ ] Verify memoization working
- [ ] Check for memory leaks
- [ ] Bundle size analysis (<150kB)

---

## Technical Requirements

### Testing Tools
```json
{
  "devDependencies": {
    "vitest": "^3.2.4",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^14.6.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@playwright/test": "^1.40.0",
    "@axe-core/playwright": "^4.8.0"
  }
}
```

### Accessibility Test Setup
```typescript
// tests/accessibility.spec.ts
import { test, expect } from '@playwright/test'
import AxeBuilder from '@axe-core/playwright'

test('Homepage should not have accessibility violations', async ({ page }) => {
  await page.goto('/')

  const accessibilityScanResults = await new AxeBuilder({ page }).analyze()

  expect(accessibilityScanResults.violations).toEqual([])
})

test('Outfit detail should not have accessibility violations', async ({ page }) => {
  await page.goto('/?outfit=abc123')

  const accessibilityScanResults = await new AxeBuilder({ page }).analyze()

  expect(accessibilityScanResults.violations).toEqual([])
})
```

### Performance Test Setup
```typescript
// tests/performance.spec.ts
import { test, expect } from '@playwright/test'

test('Page load performance meets thresholds', async ({ page }) => {
  const startTime = Date.now()

  await page.goto('/')

  const loadTime = Date.now() - startTime

  expect(loadTime).toBeLessThan(2000) // FCP < 2s

  // Check Lighthouse metrics
  const metrics = await page.evaluate(() => {
    return JSON.parse(JSON.stringify(performance.getEntries()))
  })

  const lcp = metrics.find(m => m.name === 'largest-contentful-paint')
  expect(lcp?.startTime).toBeLessThan(2500)
})

test('Filter response time meets threshold', async ({ page }) => {
  await page.goto('/')

  const startTime = Date.now()
  await page.click('text=ผู้หญิง')
  await page.waitForSelector('[data-testid="outfit-card"]')
  const responseTime = Date.now() - startTime

  expect(responseTime).toBeLessThan(500) // <500ms including render
})
```

---

## Implementation Notes

### File Changes
**New Files:**
- `tests/accessibility.spec.ts`
- `tests/performance.spec.ts`
- `tests/e2e/filter-flow.spec.ts`
- `tests/e2e/search-flow.spec.ts`
- `tests/e2e/url-state.spec.ts`
- `tests/e2e/mobile-nav.spec.ts`
- `playwright.config.ts` (if not exists)

**Modified Files:**
- `package.json` - Add test scripts
- `.github/workflows/test.yml` - CI test automation (if applicable)

### Test Scripts
```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:e2e": "playwright test",
    "test:e2e:headed": "playwright test --headed",
    "test:a11y": "playwright test tests/accessibility",
    "test:perf": "playwright test tests/performance"
  }
}
```

---

## Quality Gates

**All tests must pass before merge:**
- [ ] Unit tests: ≥80% coverage
- [ ] Integration tests: All passing
- [ ] E2E tests: All critical flows passing
- [ ] Accessibility: Zero violations
- [ ] Performance: All metrics met
- [ ] Cross-browser: All supported browsers work
- [ ] Visual regression: No unexpected changes

---

## Dependencies

**Blocked By:**
- ✅ Story 2.1 Phase 1 (Foundation) - COMPLETE
- Story 2.1.1 (Left Panel) - Component complete
- Story 2.1.2 (Middle Panel) - Component complete
- Story 2.1.3 (Right Panel) - Component complete
- Story 2.1.4 (Interactivity) - State management complete
- Story 2.1.5 (Data Integration) - Real data flowing

**Blocks:**
- Production deployment
- Stakeholder sign-off

---

## Bug Triage

**P0 (Blocking):**
- Accessibility violations (critical/serious)
- Performance metrics not met
- E2E test failures
- Cross-browser rendering issues

**P1 (High Priority):**
- Accessibility violations (moderate)
- Minor visual regressions
- Edge case bugs
- Performance optimizations

**P2 (Nice to Have):**
- Minor accessibility improvements
- Code refactoring
- Additional tests

---

## Testing Requirements

### Manual Testing Checklist
**Desktop (1440px):**
- [ ] All three panels visible
- [ ] Filters update outfit grid
- [ ] Search works correctly
- [ ] Outfit detail view works
- [ ] Buy Now buttons open correct URLs
- [ ] Back navigation works
- [ ] Thai text renders correctly

**Mobile (375px):**
- [ ] Bottom tabs switch views
- [ ] Filters full-screen modal works
- [ ] Outfit grid scrolls smoothly
- [ ] Chat interface accessible
- [ ] Touch targets adequate size
- [ ] Thai text legible

**Accessibility:**
- [ ] Tab key navigates correctly
- [ ] ESC key closes modals
- [ ] Screen reader announces changes
- [ ] Focus visible on all elements
- [ ] Color contrast sufficient

---

## Success Metrics

- [ ] Lighthouse accessibility score ≥95
- [ ] Lighthouse performance score ≥90
- [ ] Zero critical accessibility violations
- [ ] All E2E tests passing
- [ ] Cross-browser compatibility 100%
- [ ] Performance metrics met
- [ ] No console errors or warnings
- [ ] Thai font renders on all devices

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tests written and passing
- [ ] Accessibility audit passed
- [ ] Performance benchmarks met
- [ ] Cross-browser testing complete
- [ ] Visual regression baseline captured
- [ ] All bugs triaged and P0/P1 fixed
- [ ] Code reviewed and approved
- [ ] Documentation updated
- [ ] QA sign-off received
- [ ] Ready for production deployment

---

**Created:** 2025-10-05
**Last Updated:** 2025-10-05
**Related:** Story 2.1, All previous phases (2.1.0 - 2.1.5)

---

## Appendix: Testing Devices

### Desktop Devices
- MacBook Pro 16" (1920x1200)
- Windows Desktop (1920x1080)
- iMac 27" (2560x1440)

### Mobile Devices
- iPhone 14 Pro (390x844)
- iPhone SE (375x667)
- Samsung Galaxy S21 (360x800)
- iPad Air (820x1180)

### Browsers
- Chrome 120+
- Safari 17+
- Firefox 121+
- Edge 120+
