# Story 2.1.5: Data Integration - Story 1.5 Outfit Generation

**Parent Epic:** Story 2.1 Three-Panel Layout Redesign
**Phase:** 6 (Days 16-17)
**Status:** Ready for Development
**Priority:** High
**Estimated Effort:** 2 days (includes buffer for Story 1.5 QA fixes)

---

## User Story

**As a** OOTDay user,
**I want** real AI-generated outfit recommendations from the 2,636-product catalog displayed in the three-panel layout,
**so that** I can discover complete looks curated specifically from available Central Group inventory.

---

## Acceptance Criteria

### AC1: Story 1.5 Integration Verification
- [ ] Story 1.5 (Outfit Generation) QA complete and approved
- [ ] Outfit generation API/service available
- [ ] Product catalog (2,636 items) accessible
- [ ] All 179 Story 1.5 tests passing
- [ ] No blocking bugs in outfit generation

### AC2: Replace Mock Data with Generated Outfits
- [ ] Remove mockOutfits from app/page.tsx
- [ ] Fetch real outfits from outfit generation service
- [ ] Display generated outfits in middle panel grid
- [ ] Each outfit contains real products from catalog
- [ ] Outfit totalPrice calculated from actual product prices

### AC3: Dynamic Outfit Generation
- [ ] Generate outfits based on filter criteria:
  - Gender filter → Men's/Women's products
  - Occasion filter → Matching outfit style
  - Price range → Total price within budget
- [ ] Minimum 20 outfits per filter combination
- [ ] Cache generated outfits to avoid regeneration
- [ ] Loading state while generating new outfits

### AC4: Product Image Display
- [ ] Display actual product images from catalog
- [ ] Handle Central CDN image URLs correctly
- [ ] Fallback placeholder for missing/broken images
- [ ] Lazy loading for performance
- [ ] 3:4 aspect ratio maintained
- [ ] Next.js Image component optimization

### AC5: Outfit Metadata
- [ ] Each outfit has proper metadata:
  - `id`: Unique identifier
  - `title`: Descriptive Thai name
  - `description`: Outfit description
  - `style`: Occasion tag (work/casual/date/formal)
  - `totalPrice`: Sum of product prices
  - `items`: Array of Product objects
  - `previewImage`: Outfit preview (composite or first item)

### AC6: Error Handling
- [ ] Graceful degradation if outfit generation fails
- [ ] Error message: "ไม่สามารถสร้างชุดได้ในขณะนี้ กรุณาลองใหม่"
- [ ] Retry mechanism (max 3 attempts)
- [ ] Fallback to cached outfits if available
- [ ] Log errors for monitoring

### AC7: Performance Requirements
- [ ] Initial outfit generation <2 seconds
- [ ] Filter-based regeneration <1 second
- [ ] No UI blocking during generation
- [ ] Progress indicator for slow generations
- [ ] Cancel ongoing generation if filters change

---

## Technical Requirements

### Outfit Generation Service Integration
```typescript
// lib/services/outfit-service.ts
import { generateOutfits } from '@/lib/outfit-generator'
import type { Outfit, Product, FilterState } from '@/lib/types'

export async function fetchOutfits(
  products: Product[],
  filters?: FilterState,
  count: number = 50
): Promise<Outfit[]> {
  try {
    // Filter products by gender
    let filteredProducts = products
    if (filters?.gender && filters.gender !== 'all') {
      filteredProducts = products.filter(
        p => p.category?.toLowerCase() === filters.gender
      )
    }

    // Generate outfits using Story 1.5 logic
    const outfits = await generateOutfits({
      products: filteredProducts,
      style: filters?.occasion?.[0], // First selected occasion
      priceRange: filters?.priceRange,
      count
    })

    return outfits
  } catch (error) {
    console.error('Failed to generate outfits:', error)
    throw new Error('Outfit generation failed')
  }
}
```

### App Integration
```typescript
// app/page.tsx
export default function HomePage() {
  const [products, setProducts] = useState<Product[]>([])
  const [outfits, setOutfits] = useState<Outfit[]>([])
  const [isLoadingOutfits, setIsLoadingOutfits] = useState(false)
  const [outfitError, setOutfitError] = useState<string | null>(null)

  // Load products on mount
  useEffect(() => {
    fetch('/api/products')
      .then(res => res.json())
      .then(data => setProducts(data.products))
  }, [])

  // Generate outfits when products load or filters change
  useEffect(() => {
    if (products.length === 0) return

    setIsLoadingOutfits(true)
    setOutfitError(null)

    fetchOutfits(products, filters)
      .then(setOutfits)
      .catch(err => {
        setOutfitError('ไม่สามารถสร้างชุดได้ในขณะนี้')
        console.error(err)
      })
      .finally(() => setIsLoadingOutfits(false))
  }, [products, filters])

  return (
    <OutfitDiscovery
      outfits={outfits}
      isLoading={isLoadingOutfits}
      error={outfitError}
      onSelectOutfit={selectOutfit}
    />
  )
}
```

### Caching Strategy
```typescript
// lib/hooks/useOutfitCache.ts
const outfitCache = new Map<string, Outfit[]>()

function getCacheKey(filters: FilterState): string {
  return JSON.stringify(filters)
}

export function useOutfitCache() {
  const getFromCache = (filters: FilterState): Outfit[] | null => {
    const key = getCacheKey(filters)
    return outfitCache.get(key) || null
  }

  const saveToCache = (filters: FilterState, outfits: Outfit[]) => {
    const key = getCacheKey(filters)
    outfitCache.set(key, outfits)
  }

  const clearCache = () => {
    outfitCache.clear()
  }

  return { getFromCache, saveToCache, clearCache }
}
```

### Product Image Handling
```typescript
// components/ui/ProductImage.tsx
import Image from 'next/image'
import { useState } from 'react'

export function ProductImage({ product, className }: { product: Product; className?: string }) {
  const [error, setError] = useState(false)
  const [loading, setLoading] = useState(true)

  if (error) {
    return (
      <div className={`bg-gray-100 flex items-center justify-center ${className}`}>
        <ShoppingBag className="w-12 h-12 text-gray-400" />
      </div>
    )
  }

  return (
    <div className={`relative ${className}`}>
      {loading && (
        <div className="absolute inset-0 bg-gray-200 animate-pulse" />
      )}
      <Image
        src={product.imageUrl}
        alt={product.name}
        fill
        className="object-cover"
        onLoad={() => setLoading(false)}
        onError={() => {
          setError(true)
          setLoading(false)
        }}
      />
    </div>
  )
}
```

---

## Implementation Notes

### File Changes
**New Files:**
- `lib/services/outfit-service.ts`
- `lib/hooks/useOutfitCache.ts`
- `components/ui/ProductImage.tsx`

**Modified Files:**
- `app/page.tsx` - Replace mockOutfits with fetchOutfits
- `components/outfit/OutfitCard.tsx` - Use ProductImage component
- `components/outfit/OutfitDetail.tsx` - Display real product images

### Story 1.5 Dependencies
**Required from Story 1.5:**
- `lib/outfit-generator.ts` - Main outfit generation logic
- Product interface with all required fields
- Outfit generation tests (179 tests)

**Integration Points:**
- Product catalog API: `/api/products`
- Outfit generation function: `generateOutfits()`
- Style classification logic (if implemented)

---

## Dependencies

**Blocked By:**
- ✅ Story 2.1 Phase 1 (Foundation) - COMPLETE
- Story 2.1.2 (Middle Panel) - Outfit grid components
- Story 2.1.4 (Interactivity) - Filter state management
- Story 1.5 (Outfit Generation) - QA MUST be complete

**Blocks:**
- Story 2.1.7 (Testing) - Needs real data for E2E tests

**Critical Dependency:**
Story 1.5 MUST be QA-approved before starting this story. If Story 1.5 has bugs, allocate buffer time (Days 16-17) for fixes.

---

## Risk Mitigation

### Risk 1: Story 1.5 Not QA-Approved
**Mitigation:**
- Daily check-in with Story 1.5 team
- 2-day buffer allocated (Days 16-17)
- Fallback: Use mock outfits with catalog product images

### Risk 2: Outfit Generation Performance
**Mitigation:**
- Implement caching strategy
- Show loading states
- Generate outfits in background worker
- Progressive loading (show first 20, load more)

### Risk 3: Product Image CDN Issues
**Mitigation:**
- Implement robust error handling
- Fallback placeholder images
- Retry mechanism for failed loads
- Monitor image load success rate

---

## Testing Requirements

- [ ] Integration test: fetchOutfits returns valid outfits
- [ ] Integration test: Filters affect outfit generation
- [ ] Integration test: Product images load correctly
- [ ] Integration test: Cache works correctly
- [ ] Error handling test: Graceful degradation on failure
- [ ] Performance test: Generation completes <2 seconds
- [ ] Visual test: Real product images display correctly
- [ ] E2E test: Complete flow with real data

---

## Success Metrics

- [ ] Outfit generation completes <2 seconds
- [ ] All product images load successfully (>95% success rate)
- [ ] Cache hit rate >50% after initial use
- [ ] Zero UI blocking during generation
- [ ] Error recovery works correctly
- [ ] Real outfits display in grid
- [ ] Product prices calculate correctly
- [ ] Integration with Story 1.5 verified

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Story 1.5 QA complete and integrated
- [ ] Code reviewed and approved
- [ ] Integration tests passing
- [ ] Performance benchmarks met
- [ ] Error handling verified
- [ ] Product images loading correctly
- [ ] Documentation updated
- [ ] Merged to main branch
- [ ] Deployed to staging environment

---

**Created:** 2025-10-05
**Last Updated:** 2025-10-05
**Related:** Story 2.1, Story 2.1.2, Story 2.1.4, Story 1.5 (Outfit Generation)

---

## Pre-Implementation Checklist

Before starting this story:
- [ ] Verify Story 1.5 status is "QA Complete"
- [ ] Confirm all 179 Story 1.5 tests passing
- [ ] Review outfit generation API documentation
- [ ] Test product catalog API availability
- [ ] Allocate buffer time if Story 1.5 needs fixes
