# Story 2.1.4: Interactivity & State Management

**Parent Epic:** Story 2.1 Three-Panel Layout Redesign
**Phase:** 5 (Days 14-15)
**Status:** Ready for Development
**Priority:** High
**Estimated Effort:** 2 days

---

## User Story

**As a** OOTDay user,
**I want** filters, search, and selections to work seamlessly across all three panels with URL persistence,
**so that** I can refine my outfit search, share specific views with others, and have my preferences remembered when navigating back/forward.

---

## Acceptance Criteria

### AC1: Filter State Synchronization
- [ ] Left panel filter changes update middle panel outfit grid immediately
- [ ] Filter pills in middle panel sync with left panel occasion checkboxes
- [ ] Price range changes trigger outfit filtering
- [ ] Gender filter updates outfit grid
- [ ] All filters work together (AND logic)
- [ ] Debounced updates (300ms) prevent excessive re-renders

### AC2: Search Functionality
- [ ] Search query filters outfits by title, description, occasion
- [ ] Debounced search (300ms delay)
- [ ] Search works in combination with other filters
- [ ] Clear search button (X) resets search query
- [ ] Search persists in URL query params
- [ ] Case-insensitive search

### AC3: Outfit Selection Flow
- [ ] Clicking outfit in middle panel:
  - Updates selectedOutfit state
  - Switches right panel to detail view
  - Updates URL with outfit ID
  - Scrolls detail view to top
- [ ] "Explore more outfits" button:
  - Clears selectedOutfit
  - Returns right panel to chat view
  - Removes outfit ID from URL
- [ ] Selecting different outfit while in detail view switches to new outfit

### AC4: URL State Persistence
- [ ] URL format: `/?gender=women&occasion=work,date&price=1000-5000&search=ชุดทำงาน&outfit=abc123`
- [ ] All filter state reflected in URL query params
- [ ] Browser back/forward buttons work correctly
- [ ] Sharing URL loads same filter state
- [ ] URL updates without page reload (pushState)
- [ ] Initial load reads URL params and applies filters

### AC5: State Hook - useOutfitDiscovery
- [ ] Central state management hook
- [ ] Manages: filters, selectedOutfit, viewMode, filteredOutfits
- [ ] Provides: setFilters, selectOutfit, backToChat, resetFilters
- [ ] Memoized filtered outfits calculation
- [ ] URL sync on state changes
- [ ] Type-safe with FilterState interface

### AC6: Filter Reset Functionality
- [ ] "Clear all filters" button in left panel
- [ ] Resets gender to "all"
- [ ] Clears all occasion checkboxes
- [ ] Resets price range to min-max
- [ ] Clears search query
- [ ] Returns to default state
- [ ] Updates URL to remove all params

### AC7: Loading States
- [ ] Skeleton loaders while fetching outfits
- [ ] Loading spinner during filter operations
- [ ] Disabled state for filters while loading
- [ ] Smooth transitions between states
- [ ] No layout shifts during load

---

## Technical Requirements

### useOutfitDiscovery Hook
```typescript
// lib/hooks/useOutfitDiscovery.ts
export function useOutfitDiscovery(allOutfits: Outfit[]) {
  const router = useRouter()
  const searchParams = useSearchParams()

  // Initialize state from URL
  const [filters, setFilters] = useState<FilterState>(() => ({
    gender: (searchParams.get('gender') as FilterState['gender']) || 'all',
    occasion: searchParams.get('occasion')?.split(',') || [],
    priceRange: {
      min: Number(searchParams.get('priceMin')) || 0,
      max: Number(searchParams.get('priceMax')) || 20000
    },
    searchQuery: searchParams.get('search') || ''
  }))

  const [selectedOutfit, setSelectedOutfit] = useState<Outfit | null>(null)
  const [viewMode, setViewMode] = useState<'chat' | 'detail'>('chat')

  // Memoized filtered outfits
  const filteredOutfits = useMemo(() => {
    return filterOutfits(allOutfits, filters)
  }, [allOutfits, filters])

  // Sync URL with state
  useEffect(() => {
    const params = new URLSearchParams()

    if (filters.gender && filters.gender !== 'all') {
      params.set('gender', filters.gender)
    }
    if (filters.occasion && filters.occasion.length > 0) {
      params.set('occasion', filters.occasion.join(','))
    }
    if (filters.priceRange) {
      params.set('priceMin', String(filters.priceRange.min))
      params.set('priceMax', String(filters.priceRange.max))
    }
    if (filters.searchQuery) {
      params.set('search', filters.searchQuery)
    }
    if (selectedOutfit) {
      params.set('outfit', selectedOutfit.id)
    }

    const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname
    window.history.pushState({}, '', newUrl)
  }, [filters, selectedOutfit])

  // Handlers
  const selectOutfit = (outfit: Outfit) => {
    setSelectedOutfit(outfit)
    setViewMode('detail')
  }

  const backToChat = () => {
    setSelectedOutfit(null)
    setViewMode('chat')
  }

  const resetFilters = () => {
    setFilters({
      gender: 'all',
      occasion: [],
      priceRange: { min: 0, max: 20000 },
      searchQuery: ''
    })
  }

  return {
    filters,
    setFilters,
    filteredOutfits,
    selectedOutfit,
    viewMode,
    selectOutfit,
    backToChat,
    resetFilters
  }
}
```

### Outfit Filtering Logic
```typescript
// lib/utils/outfit-filter.ts
export function filterOutfits(
  outfits: Outfit[],
  filters: FilterState
): Outfit[] {
  return outfits.filter(outfit => {
    // Gender filter
    if (filters.gender && filters.gender !== 'all') {
      const hasMatchingGender = outfit.items.some(
        item => item.category?.toLowerCase() === filters.gender
      )
      if (!hasMatchingGender) return false
    }

    // Occasion filter
    if (filters.occasion && filters.occasion.length > 0) {
      // Requires outfit.style field from Story 1.5
      // if (!filters.occasion.includes(outfit.style)) return false
    }

    // Price range filter
    if (filters.priceRange) {
      if (outfit.totalPrice < filters.priceRange.min ||
          outfit.totalPrice > filters.priceRange.max) {
        return false
      }
    }

    // Search query
    if (filters.searchQuery) {
      const query = filters.searchQuery.toLowerCase()
      const matchesTitle = outfit.title.toLowerCase().includes(query)
      const matchesDesc = outfit.description?.toLowerCase().includes(query)
      if (!matchesTitle && !matchesDesc) return false
    }

    return true
  })
}
```

### URL Search Params Utilities
```typescript
// lib/utils/url-params.ts
export function parseFiltersFromUrl(searchParams: URLSearchParams): FilterState {
  return {
    gender: (searchParams.get('gender') as FilterState['gender']) || 'all',
    occasion: searchParams.get('occasion')?.split(',').filter(Boolean) || [],
    priceRange: {
      min: Number(searchParams.get('priceMin')) || 0,
      max: Number(searchParams.get('priceMax')) || 20000
    },
    searchQuery: searchParams.get('search') || ''
  }
}

export function filtersToUrlParams(filters: FilterState): string {
  const params = new URLSearchParams()

  if (filters.gender && filters.gender !== 'all') {
    params.set('gender', filters.gender)
  }
  if (filters.occasion && filters.occasion.length > 0) {
    params.set('occasion', filters.occasion.join(','))
  }
  if (filters.priceRange) {
    if (filters.priceRange.min > 0) {
      params.set('priceMin', String(filters.priceRange.min))
    }
    if (filters.priceRange.max < 20000) {
      params.set('priceMax', String(filters.priceRange.max))
    }
  }
  if (filters.searchQuery) {
    params.set('search', filters.searchQuery)
  }

  return params.toString()
}
```

---

## Implementation Notes

### File Changes
**New Files:**
- `lib/hooks/useOutfitDiscovery.ts`
- `lib/utils/outfit-filter.ts`
- `lib/utils/url-params.ts`

**Modified Files:**
- `app/page.tsx` - Replace local state with useOutfitDiscovery hook
- `components/navigation/NavigationFilters.tsx` - Use hook for filter updates
- `components/outfit/OutfitDiscovery.tsx` - Use hook for filtered outfits
- `components/outfit/OutfitCard.tsx` - Use hook's selectOutfit handler
- `components/outfit/OutfitDetail.tsx` - Use hook's backToChat handler

### Usage in page.tsx
```typescript
export default function HomePage() {
  const [allOutfits, setAllOutfits] = useState<Outfit[]>(mockOutfits)

  const {
    filters,
    setFilters,
    filteredOutfits,
    selectedOutfit,
    viewMode,
    selectOutfit,
    backToChat,
    resetFilters
  } = useOutfitDiscovery(allOutfits)

  return (
    <div className="flex h-screen">
      <NavigationFilters
        filters={filters}
        onFilterChange={setFilters}
        onResetFilters={resetFilters}
      />
      <OutfitDiscovery
        outfits={filteredOutfits}
        onSelectOutfit={selectOutfit}
      />
      <RightPanel
        viewMode={viewMode}
        selectedOutfit={selectedOutfit}
        onBackToChat={backToChat}
      />
    </div>
  )
}
```

---

## Dependencies

**Blocked By:**
- ✅ Story 2.1 Phase 1 (Foundation) - COMPLETE
- Story 2.1.1 (Left Panel) - Filter components
- Story 2.1.2 (Middle Panel) - Outfit grid
- Story 2.1.3 (Right Panel) - View mode state

**Blocks:**
- Story 2.1.6 (Data Integration) - Filter logic needed for outfit generation
- Story 2.1.7 (Testing) - Full functionality required for E2E tests

---

## Testing Requirements

- [ ] Unit tests for useOutfitDiscovery hook
- [ ] Unit tests for filterOutfits function
- [ ] Unit tests for URL param utilities
- [ ] Integration test: Filter changes update outfit grid
- [ ] Integration test: URL state persists on reload
- [ ] Integration test: Browser back/forward buttons work
- [ ] Integration test: Selecting outfit updates URL
- [ ] E2E test: Complete user flow (filter → select → back)

---

## Success Metrics

- [ ] Filter updates reflected in <100ms
- [ ] URL updates without page reload
- [ ] Browser back/forward work correctly
- [ ] Shared URLs load correct state
- [ ] No race conditions in state updates
- [ ] All hooks properly memoized
- [ ] Zero unnecessary re-renders
- [ ] Component passes all unit tests

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code reviewed and approved
- [ ] Unit tests written and passing (≥80% coverage)
- [ ] Integration tests passing
- [ ] URL state persistence verified
- [ ] Performance benchmarks met
- [ ] Documentation updated
- [ ] Merged to main branch
- [ ] Deployed to staging environment

---

**Created:** 2025-10-05
**Last Updated:** 2025-10-05
**Related:** Story 2.1, Story 2.1.1, Story 2.1.2, Story 2.1.3, Story 2.1.6
