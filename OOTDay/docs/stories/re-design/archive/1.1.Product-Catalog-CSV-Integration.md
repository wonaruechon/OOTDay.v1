# Story 1.1: Product Catalog CSV Integration - Brownfield Addition

## Status
Done

## Story

**As a** fashion-conscious user,
**I want** to see real products from Central Group's catalog,
**so that** I can browse and purchase actual available items.

## Story Context

**Existing System Integration:**
- Integrates with: `lib/mock-data.ts`, `lib/types.ts`
- Technology: Next.js, TypeScript, CSV parsing
- Follows pattern: Existing Product interface structure
- Touch points: All components that consume `mockProducts` array

## Acceptance Criteria

**Functional Requirements:**
1. CSV parser reads Product_Men.csv and Product_Woman.csv from `/docs` directory
2. CSV data maps correctly to existing Product interface
3. Products are available for both men's and women's categories

**Integration Requirements:**
4. Existing Product interface remains unchanged
5. Components consuming product data continue to work without modification
6. CSV parsing happens at build time or on application initialization

**Quality Requirements:**
7. CSV parsing includes error handling for malformed data
8. Product images from CSV URLs load correctly
9. All existing product-related functionality continues to work

## Technical Notes

- **Integration Approach:** Create `lib/product-loader.ts` utility to parse CSV and transform into Product[] array
- **Existing Pattern Reference:** Follow the structure of `mockProducts` in `lib/mock-data.ts`
- **Key Constraints:**
  - CSV fields: Category, Sub-Category, Product ID (SKU), Product image, PIC, Product name, Brand, Description, Size, Original_Price, Discount (If any), Current price, Sale link
  - Must handle Thai language product names and descriptions
  - Image URLs are from Central Group CDN

## Tasks / Subtasks

- [x] Create CSV parser utility (AC: 1, 7)
  - [x] Install CSV parsing library (papaparse)
  - [x] Create `lib/product-loader.ts` utility
  - [x] Implement CSV to Product[] transformation with error handling
  - [x] Handle Thai language encoding properly (UTF-8 BOM removal)
- [x] Parse Men's product catalog (AC: 2, 3)
  - [x] Read Product_Men.csv from `/docs` directory via API route
  - [x] Map CSV fields to Product interface
  - [x] Validate required fields exist
- [x] Parse Women's product catalog (AC: 2, 3)
  - [x] Read Product_Woman.csv from `/docs` directory via API route
  - [x] Map CSV fields to Product interface
  - [x] Validate required fields exist
- [x] Integrate parsed data (AC: 4, 5, 6, 9)
  - [x] Create API route for server-side CSV parsing
  - [x] Update mockProducts to load from API
  - [x] Verify all components work with real data
  - [x] Test product images load correctly (AC: 8)
- [x] Testing and validation
  - [x] Test with malformed CSV data (error handling)
  - [x] Verify no TypeScript errors
  - [x] Test CSV parsing logic with unit tests

## Dev Notes

**Relevant Source Tree:**
- `frontend/lib/types.ts` - Product interface definition
- `frontend/lib/mock-data.ts` - Current mock products to be replaced
- `frontend/components/product/ProductModal.tsx` - Main product display component
- `frontend/components/outfit/OutfitCard.tsx` - Uses product data
- `docs/Product_Men.csv` - Men's product catalog
- `docs/Product_Woman.csv` - Women's product catalog

**CSV Data Structure:**
```
Category, Sub-Category, Product ID (SKU), Product image, PIC, Product name, Brand, Description, Size, Original_Price, Discount (If any), Current price, Sale link
```

**Product Interface (from types.ts):**
```typescript
interface Product {
  sku: string
  name: string
  brand: string
  price: number
  imageUrl: string
  availability: "in_stock" | "low_stock" | "out_of_stock"
  storeLocations?: string[]
  onlineUrl?: string
  sizes?: string[]
  colors?: string[]
}
```

**Mapping Notes:**
- `Product ID (SKU)` → `sku`
- `Product name` → `name`
- `Brand` → `brand`
- `Current price` → `price`
- `Product image` → `imageUrl`
- `Sale link` → `onlineUrl`
- `Size` → parse into `sizes[]` array
- `availability` → default to "in_stock" (can be enhanced later)
- `storeLocations` → can be added later
- `colors` → can be extracted from description or added later

### Testing

**Testing Standards:**
- Test file location: `frontend/lib/__tests__/product-loader.test.ts`
- Testing framework: Jest (Next.js default)
- Test requirements:
  - Unit tests for CSV parsing function
  - Test error handling with malformed CSV
  - Test Thai language character handling
  - Test Product interface mapping
  - Integration test with actual CSV files

## Risk and Compatibility

**Minimal Risk Assessment:**
- **Primary Risk:** CSV parsing errors or malformed data causing application crashes
- **Mitigation:** Implement try-catch with fallback to empty array; validate required fields
- **Rollback:** Keep mock-data.ts as backup; simple import swap

**Compatibility Verification:**
- [x] No breaking changes to Product interface
- [x] CSV parsing is additive only (no database changes)
- [x] UI continues to use same Product type
- [x] Performance impact minimal (CSV parsed once at startup)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-10-03 | 1.1 | Completed CSV integration with 2,636 products loaded | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Fixed UTF-8 BOM handling in CSV parsing
- Resolved price field mapping (Original_Price vs Current price)
- API path resolution for docs directory across build/runtime contexts

### Completion Notes List
- Successfully integrated 2,636 products from Central Group CSV catalogs (Men: 1,318 | Women: 1,318)
- Implemented server-side API route (/api/products) for CSV parsing with Next.js filesystem access
- CSV parser handles Thai language product names and descriptions correctly
- Price mapping uses Original_Price field (Current price field is empty in source CSVs)
- UTF-8 BOM automatically removed from CSV headers
- Product images use Central Group CDN URLs (assets.central.co.th)
- All existing Product interface fields maintained - zero breaking changes
- API includes caching headers for performance (s-maxage=3600)
- Comprehensive error handling with fallback to mock products
- 12 new unit tests added for CSV parsing logic (100% passing)
- Total test suite: 99 tests passing (previous 87 + new 12)

### File List
- **Created**: `frontend/app/api/products/route.ts` - Server-side API endpoint for CSV parsing
- **Created**: `frontend/lib/product-loader.ts` - CSV parser utility (for reference/server-side use)
- **Created**: `frontend/lib/product-data.ts` - Product catalog data provider helper
- **Modified**: `frontend/lib/mock-data.ts` - Added loadProductCatalog() function and getProducts() helper
- **Modified**: `frontend/package.json` - Added papaparse and @types/papaparse dependencies
- **Created**: `frontend/lib/__tests__/product-loader.test.ts` - Unit tests for CSV parsing (12 tests)
- **Source**: `docs/Product_Men.csv` - Men's product catalog (1,318 products)
- **Source**: `docs/Product_Woman.csv` - Women's product catalog (1,318 products)

## QA Results
_To be populated by QA agent_
