# Story 1.4: Add Buy Now Button with Gender-Specific URLs - Brownfield Addition

## Status
Done

## Story

**As a** user interested in purchasing a product,
**I want** a "Buy Now" button that directs me to the appropriate Central Group online store,
**so that** I can complete my purchase on the correct men's or women's section.

## Story Context

**Existing System Integration:**
- Integrates with: Product detail component, Product interface
- Technology: Next.js, React, external link handling
- Follows pattern: Existing "Buy Online" button in ProductModal.tsx line 254
- Touch points: Product detail component, Product data model

## Acceptance Criteria

**Functional Requirements:**
1. "Buy Now" button added to product detail view
2. Button links to gender-specific Central Group URLs (men vs women)
3. Link opens in new tab/window when clicked

**Integration Requirements:**
4. Product interface extended with optional `category` or `gender` field
5. Gender determination logic uses product category from CSV data
6. Fallback URL provided if gender cannot be determined

**Quality Requirements:**
7. Button styled consistently with existing UI design system
8. Button disabled for out-of-stock products
9. External link includes proper security attributes (rel="noopener noreferrer")

## Technical Notes

- **Integration Approach:**
  - Add gender/category field to Product interface
  - Create utility function `getGenderSpecificUrl(product)` to return appropriate URL
  - Replace or enhance existing "Buy Online" button with "Buy Now" + gender-specific logic
- **Existing Pattern Reference:**
  - Current "Buy Online" button: ProductModal.tsx line 254 (`onClick={() => window.open(product.onlineUrl, "_blank")}`)
- **Key Constraints:**
  - Women URL: `https://www.central.co.th/th/women`
  - Men URL: `https://www.central.co.th/th/men`
  - CSV Category field indicates gender (e.g., "Men" or "Women")
  - Must handle unisex or undefined categories gracefully

## Tasks / Subtasks

- [x] Update Product interface (AC: 4)
  - [x] Add optional `category` field to Product type in types.ts
  - [x] Update CSV parser to extract Category field from CSV
  - [x] Update existing mock data if needed for testing
- [x] Create gender-specific URL utility (AC: 2, 5, 6)
  - [x] Create `lib/utils/product-utils.ts` (if not exists)
  - [x] Implement `getGenderSpecificUrl(product: Product): string` function
  - [x] Logic: if category includes "Men" → men URL, if "Women" → women URL
  - [x] Fallback: return generic Central homepage or current `onlineUrl`
- [x] Update Buy Now button (AC: 1, 3, 7, 8, 9)
  - [x] Update "Buy Online" button to "Buy Now" in ProductDetail component
  - [x] Use `getGenderSpecificUrl()` instead of direct `product.onlineUrl`
  - [x] Ensure button opens link in new tab with security attributes
  - [x] Disable button for out-of-stock products (already implemented)
  - [x] Style button consistently with design system
- [x] Testing and validation
  - [x] Test with men's products → correct URL
  - [x] Test with women's products → correct URL
  - [x] Test with products without category → fallback URL
  - [x] Verify button disabled for out-of-stock items
  - [x] Verify link opens in new tab securely

## Dev Notes

**Relevant Source Tree:**
- `frontend/components/product/ProductDetail.tsx` - Product detail component (contains "Buy Online" button)
- `frontend/lib/types.ts` - Product interface definition
- `frontend/lib/product-loader.ts` - CSV parser (created in Story 1.1)
- `docs/Product_Men.csv` - Men's product catalog (has "Men" in Category field)
- `docs/Product_Woman.csv` - Women's product catalog (has "Women" in Category field - note: both files have same header)

**Product Interface Extension:**
```typescript
export interface Product {
  // ... existing fields
  category?: string // Add this field: "Men", "Women", or other
}
```

**Gender-Specific URL Logic:**
```typescript
function getGenderSpecificUrl(product: Product): string {
  const category = product.category?.toLowerCase() || ''

  if (category.includes('men') && !category.includes('women')) {
    return 'https://www.central.co.th/th/men'
  } else if (category.includes('women')) {
    return 'https://www.central.co.th/th/women'
  }

  // Fallback: use product's own URL or generic Central homepage
  return product.onlineUrl || 'https://www.central.co.th'
}
```

**Button Implementation:**
```tsx
<Button
  className="w-full"
  disabled={product.availability === "out_of_stock"}
  onClick={() => window.open(getGenderSpecificUrl(product), "_blank", "noopener,noreferrer")}
>
  <ShoppingBag className="w-4 h-4 mr-2" />
  Buy Now
</Button>
```

### Testing

**Testing Standards:**
- Test file location: `frontend/lib/utils/__tests__/product-utils.test.ts`
- Testing framework: Jest
- Test requirements:
  - Unit test `getGenderSpecificUrl()` with men's product → men URL
  - Unit test `getGenderSpecificUrl()` with women's product → women URL
  - Unit test `getGenderSpecificUrl()` with no category → fallback URL
  - Unit test `getGenderSpecificUrl()` with unisex category → fallback URL
  - Integration test: button click opens correct URL in new tab
  - Test button is disabled for out-of-stock products

## Risk and Compatibility

**Minimal Risk Assessment:**
- **Primary Risk:** Incorrect gender classification leading to wrong store section
- **Mitigation:** Explicit category field from CSV source; test thoroughly with real data; fallback URL ensures users can still shop
- **Rollback:** Revert to original `product.onlineUrl` usage

**Compatibility Verification:**
- [x] Product interface extended with optional field (non-breaking)
- [x] Existing products without category field continue to work (fallback)
- [x] No database changes (CSV source of truth)
- [x] Performance impact negligible (simple string check)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-10-03 | 1.1 | Completed implementation | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Build successful: TypeScript compilation passed
- Unit tests passing: 7/7 tests for gender-specific URL logic
- CSV category field successfully extracted: "Men" and "Women" categories

### Completion Notes List
- Added `category?: string` field to Product interface (types.ts:39)
- Updated CSV parser to extract Category field from CSV data (product-loader.ts:108)
- Created product-utils.ts utility module with getGenderSpecificUrl() function
- Gender detection logic: checks for "men" (excluding "women") → men URL, "women" → women URL
- Fallback logic: uses product.onlineUrl if available, otherwise Central homepage
- Updated ProductDetail component: "Buy Online" → "Buy Now" button (ProductDetail.tsx:257-261)
- Button opens URL in new tab with security attributes: window.open(..., "_blank", "noopener,noreferrer")
- Button correctly disabled for out_of_stock products (existing functionality preserved)
- All 7 unit tests passing for gender-specific URL logic
- Case-insensitive category matching implemented
- Correctly handles "women" category without matching "men" substring

### File List
- **Modified**: `frontend/lib/types.ts` - Added category field to Product interface
- **Modified**: `frontend/lib/product-loader.ts` - Extract Category from CSV
- **Created**: `frontend/lib/utils/product-utils.ts` - Gender-specific URL utility
- **Modified**: `frontend/components/product/ProductDetail.tsx` - Buy Now button with gender URLs
- **Created**: `frontend/lib/utils/__tests__/product-utils.test.ts` - Unit tests (7 tests)

## QA Results
_To be populated by QA agent_
